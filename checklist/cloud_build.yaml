steps:
  # The first two steps are required to identify and inject un-redacted secrets.
  - name: gcr.io/cloud-builders/npm
    args:
      - install
      - yaml
  - name: gcr.io/cloud-builders/npm
    args:
      - run
      - replace-secrets
      - --
      - checklist
    secretEnv:
      - PRIVATE_KEY
      - WEBHOOK_SECRET

  # Compile the app from Typescript into dist/.
  - name: gcr.io/cloud-builders/npm
    dir: checklist
    args:
      - install
  - name: gcr.io/cloud-builders/npm
    dir: checklist
    args:
      - run
      - build

  # Copy over the environment and package file.
  - name: ubuntu
    dir: checklist
    args:
      - cp
      - .env
      - dist/
  - name: ubuntu
    dir: checklist
    args:
      - cp
      - package.json
      - dist/

  # Deploy the app.
  - name: gcr.io/cloud-builders/gcloud
    dir: checklist
    args:
      - functions
      - deploy
      - --source
      - dist/
      - checklist-bot
      - --entry-point
      - probot

# These secrets are the base64-encoded form of encrypted secret values. They are
# automatically decrypted and added to the `.env` environment at build time.
secrets:
  - kmsKeyName: projects/amp-checklist-bot/locations/global/keyRings/amp-github-apps-keyring/cryptoKeys/app-env-key
    secretEnv:
      PRIVATE_KEY: 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
      WEBHOOK_SECRET: CiQAawD9BWtWXBFXmYcAvNSYPpgqFp1HaxUrNiL9ufoKgjERYwkSUQC0wIdg6WnJ+cmXPyF0sDmOJTrKrx3vEuSKmL5d3D4ZJE3qqmlKO7QQj5nO6docyM1T602btUlUrUh35TxsLc0yn/rcpk/3AzpDa6sp+psaEw==
